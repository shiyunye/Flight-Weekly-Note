SELECT 
  DATE_SUB(CALD, INTERVAL EXTRACT(DAYOFWEEK FROM Cald) - 1 DAY) AS wk_begin
,DATE_ADD(DATE_TRUNC(CALD, WEEK(SUNDAY)), INTERVAL 6 DAY) AS wk_ending,
* 
FROM(
SELECT CALD,
CAMP_TYPE,
DOMAIN,
'Mobile + Desktop' AS DEVICE,
CAMP_THEME,
SUM(COMP_IMPRESSIONS) AS COMP_IMPRESSIONS,
SUM(TOTAL_IMPRESSIONS) AS TOTAL_IMPRESSIONS,
SUM(ABS_TOP_PAGE_RATE_IMPRESSIONS) AS ABS_TOP_PAGE_RATE_IMPRESSIONS,
SUM(TOP_PAGE_RATE_IMPRESSIONS) AS TOP_PAGE_RATE_IMPRESSIONS,
SUM(COMP_IMPRESSIONS)/SUM(TOTAL_IMPRESSIONS) AS IMP_S,
SUM(TOP_PAGE_RATE_IMPRESSIONS)/SUM(TOTAL_IMPRESSIONS) AS TOP_IMP_S,
SUM(ABS_TOP_PAGE_RATE_IMPRESSIONS)/SUM(TOTAL_IMPRESSIONS) AS ABS_TOP_IMP_S

FROM(

SELECT ACCOUNT_NAME, CAMP_TYPE, CAMP_THEME, TARGET_LOCATION, DOMAIN, DEVICE, CALDATE, CALD,
IMPRESSION_SHARE, ABS_TOP_PAGE_RATE, TOP_PAGE_RATE, IMP, T_IMP,
MAX(T_IMP) OVER (PARTITION BY ACCOUNT_NAME, CALDATE) AS TOTAL_IMPRESSIONS,
ROUND(IMPRESSION_SHARE * MAX(T_IMP) OVER (PARTITION BY ACCOUNT_NAME, CALDATE),2) AS COMP_IMPRESSIONS,
ROUND(IMPRESSION_SHARE * MAX(T_IMP) OVER (PARTITION BY ACCOUNT_NAME, CALDATE) * (ABS_TOP_PAGE_RATE ),2) ABS_TOP_PAGE_RATE_IMPRESSIONS,
ROUND(IMPRESSION_SHARE * MAX(T_IMP) OVER (PARTITION BY ACCOUNT_NAME, CALDATE) * (TOP_PAGE_RATE ),2) TOP_PAGE_RATE_IMPRESSIONS
FROM
(SELECT 
A.ACCOUNT_NAME
, A.DOMAIN AS OLD_DOMAIN
, A.DOMAIN AS DOMAIN
, A.CALDATE AS CALDATE
, PARSE_DATE('%Y%m%d', CAST(A.CALDATE AS STRING)) AS CALD
, CASE WHEN A.DEVICE = 'HIGH_END_MOBILE' THEN 'Mobile'
       WHEN A.DEVICE = 'DESKTOP' THEN 'Desktop'
       WHEN A.DEVICE = 'TABLET' THEN 'Tablet' END AS DEVICE
, IFNULL(B.IMPRESSION_SHARE,0) AS IMPRESSION_SHARE
, IFNULL(B.ABSOLUTE_TOP_OF_PAGE_RATE,0) AS ABS_TOP_PAGE_RATE
, IFNULL(B.TOP_OF_PAGE_RATE,0) AS TOP_PAGE_RATE
, IFNULL(B.IMPRESSIONS,0) AS IMP
, IFNULL(ROUND(CASE WHEN A.DOMAIN = 'You' THEN SAFE_DIVIDE(B.IMPRESSIONS,B.IMPRESSION_SHARE)  ELSE B.IMPRESSION_SHARE END),2) AS T_IMP
FROM   
    (
    SELECT * FROM(
                SELECT DISTINCT DOMAIN FROM `pcln-pl-mktganalytics-prod.SEM_YS.Auction_insights`
                WHERE DEVICE != 'All Devices' 
                AND ACCOUNT_NAME IN (SELECT DISTINCT ACCOUNT_NAME FROM `pcln-pl-data-prod.marketing_base.pinnacle_mktg_account_sync_view` WHERE ACCOUNT_NAME 
                                    LIKE 'G/PCLN%'AND CAST(SPEND_FLAG AS STRING)='true' AND CAST(SYNC_FLAG AS STRING)='true' AND CAST(REPORT_FLAG AS STRING)='true')
                AND ACCOUNT_NAME != 'G/PCLN/EN/US/Cruise' AND ACCOUNT_NAME LIKE 'G/PCLN%'
                ) A
            JOIN 
                (SELECT DISTINCT ACCOUNT_NAME FROM `pcln-pl-mktganalytics-prod.SEM_YS.Auction_insights`
                WHERE DEVICE != 'All Devices'
                AND ACCOUNT_NAME IN (SELECT DISTINCT ACCOUNT_NAME FROM `pcln-pl-data-prod.marketing_base.pinnacle_mktg_account_sync_view` WHERE ACCOUNT_NAME 
                                    LIKE 'G/PCLN%'AND CAST(SPEND_FLAG AS STRING)='true' AND CAST(SYNC_FLAG AS STRING)='true' AND CAST(REPORT_FLAG AS STRING)='true')
                AND ACCOUNT_NAME != 'G/PCLN/EN/US/Cruise' AND ACCOUNT_NAME LIKE 'G/PCLN%' 
                ) B ON 1=1
            JOIN
                (SELECT DISTINCT date CALDATE FROM `pcln-pl-mktganalytics-prod.SEM_YS.Auction_insights`
                WHERE PARSE_DATE('%Y%m%d', CAST(date AS STRING)) >= CURRENT_DATE()-400 AND PARSE_DATE('%Y%m%d', CAST(date AS STRING)) <= CURRENT_DATE() - 1) C ON 1=1
            JOIN
                (SELECT DISTINCT DEVICE 
                FROM `pcln-pl-mktganalytics-prod.SEM_YS.Auction_insights`
                WHERE DEVICE != 'All Devices'
                ) D ON 1=1            
    ) A
LEFT JOIN 
    (SELECT * FROM `pcln-pl-mktganalytics-prod.SEM_YS.Auction_insights` WHERE DEVICE != 'All Devices') B
ON A.DOMAIN = B.DOMAIN 
AND A.ACCOUNT_NAME = B.ACCOUNT_NAME
AND A.CALDATE = B.date
AND A.DEVICE = B.DEVICE) X
JOIN 
(SELECT DISTINCT A.ACCOUNT_NAME AS ACCOUNT, 
CASE WHEN C.CAMPAIGN_TYPE_NAME LIKE 'Astra%' AND A.ACCOUNT_NAME NOT IN ('G/PCLN/EN/US/Car/Airports','G/PCLN/EN/US/Car/City/US','G/PCLN/EN/US/Car/Supplier_Airport','G/PCLN/EN/US/Car/Supplier_City') THEN 'Astra' 
WHEN A.ACCOUNT_NAME IN ('G/PCLN/EN/US/Car/Airports','G/PCLN/EN/US/Car/City/US','G/PCLN/EN/US/Car/Generic','G/PCLN/EN/US/Car/Supplier_Airport','G/PCLN/EN/US/Car/Supplier_City') THEN 'Rental Car'
WHEN A.ACCOUNT_NAME IN ('G/PCLN/EN/US/Hotel/City/Canada','G/PCLN/EN/US/Hotel/Generic') THEN 'Hotel'
WHEN A.ACCOUNT_NAME = 'G/PCLN/EN/US/AllProd/GenCom' THEN 'All Products'
ELSE C.CAMPAIGN_TYPE_NAME END AS CAMP_TYPE, 
CASE WHEN C.CAMPAIGN_TYPE_NAME LIKE 'Astra%' AND A.ACCOUNT_NAME NOT IN ('G/PCLN/EN/US/Car/Airports','G/PCLN/EN/US/Car/City/US','G/PCLN/EN/US/Car/Supplier_Airport','G/PCLN/EN/US/Car/Supplier_City') THEN 'Astra'
WHEN A.ACCOUNT_NAME IN ('G/PCLN/EN/US/VP/GenCom','G/PCLN/EN/US/AllProd/Competitor') THEN 'Competitor'
WHEN A.ACCOUNT_NAME = 'G/PCLN/EN/CA/Hotel/Airports/CA' THEN 'Airport'
WHEN A.ACCOUNT_NAME = 'G/PCLN/EN/US/Hotel/City/Canada' THEN 'CityState'
WHEN A.ACCOUNT_NAME = 'G/PCLN/EN/US/Hotel/Property' THEN 'Keywordless'
WHEN A.ACCOUNT_NAME = 'G/PCLN/EN/US/AllProd/GenCom' THEN 'Generic'
ELSE C.CAMPAIGN_THEME_NAME END AS CAMP_THEME,
CASE WHEN A.ACCOUNT_NAME LIKE 'G/PCLN/EN/US%' THEN 'US'
WHEN A.ACCOUNT_NAME LIKE 'G/PCLN/EN/CA%' THEN 'CA'
ELSE 'World' END AS TARGET_LOCATION
FROM `pcln-pl-data-prod.marketing_base.pinnacle_mktg_account_sync_view` A
JOIN `pcln-pl-data-prod.marketing_base.pinnacle_mktg_campaign_sync_external` B
ON A.ACCOUNT_ID = B.ACCOUNT_ID
AND A.ACCOUNT_NAME LIKE 'G/PCLN%'
AND CAST(SPEND_FLAG AS STRING) = 'true'
AND CAST(SYNC_FLAG AS STRING) = 'true'
AND CAST(REPORT_FLAG AS STRING) = 'true'
and b.partner is not null
JOIN `pcln-pl-data-prod.marketing_base.pinnacle_mktg_campaign_theme_type_view` C
ON B.partner_campaign_id = C.partner_campaign_id
) Y
ON X.ACCOUNT_NAME = Y.ACCOUNT
)
WHERE UPPER(DEVICE) IN ('DESKTOP','MOBILE')
GROUP BY 
CALD,
CAMP_TYPE,
CAMP_THEME,
DOMAIN,
DEVICE
)
WHERE IMP_S > 0.03
and camp_type = "Air"
order by 1,2,3,4,5